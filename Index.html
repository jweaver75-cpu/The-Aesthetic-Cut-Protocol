<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classic Physique Cutting & Training Blueprint</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0ffef; /* Light green-white background */
            color: #1E1E1E;
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            padding: 1.5rem;
            border-top: 5px solid #00C853; /* Green accent color */
        }
        .accent-text {
            color: #00C853; /* Green accent color */
        }
        .stat-number {
            color: #2196F3; /* Blue for the number value */
            line-height: 1.1;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 350px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 400px;
            }
        }
        .button-shadow {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.15s ease-in-out;
        }
        .button-shadow:hover {
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.2);
            transform: translateY(-1px);
        }
        .meal-card {
            border-left: 5px solid;
            padding: 1rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        /* Custom styles for the interactive training split */
        .day-tab {
            transition: all 0.2s;
            cursor: pointer;
        }
        .day-tab:hover {
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .day-tab.active {
            box-shadow: 0 0 0 3px #2196F3, 0 4px 12px rgba(33, 150, 243, 0.4); /* Blue outline for active tab */
            background-color: #E3F2FD; /* Light blue background for active */
            transform: translateY(-2px);
        }
        .workout-list {
            list-style-type: none;
            padding: 0;
        }
        .workout-list li {
            padding: 0.6rem 0;
            border-bottom: 1px dashed #E0F7FA;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .workout-list li:last-child {
            border-bottom: none;
        }
        .exercise-name {
            font-weight: 600;
            color: #1E1E1E;
        }
        .sets-reps {
            font-size: 0.9rem;
            color: #2196F3;
            background-color: #E3F2FD;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-weight: 700;
        }
    </style>
</head>
<body class="p-4 md:p-10">
    
    <script type="module">
        // Global Data for Charts and AI context
        const chartData = {
            totalCalories: 2000, targetProtein: 215, targetCarbs: 110, targetFat: 75,
            macroLabels: ['Protein (44%)', 'Carbohydrates (22%)', 'Fats (34%)'], macroPercentages: [44, 22, 34],
            mealLabels: ['Meal 1: Whey Shake', 'Meal 2: Solid Meal 1', 'Meal 3: Whey Shake', 'Meal 4: Solid Meal 2', 'Meal 5: Whey Shake'], 
            mealCalories: [320, 500, 320, 500, 320], // Total 1960 kcal
            proteinSources: [{ source: 'Whey Protein', grams: 192, color: '#2196F3' }, { source: 'Other Sources', grams: 23, color: '#FF9800' }],
            chartColors: ['#00C853', '#FF9800', '#2196F3', '#03A9F4', '#8BC34A', '#FFC107'], 
        };

        // --- Training Split Data (New) ---
        const workoutData = {
            'SAT-PUSH-A': {
                title: 'PUSH A (Saturday): Chest Volume',
                focus: 'High volume for chest mass, balanced shoulder/tricep work.',
                color: 'bg-red-50 text-red-700 border-red-300',
                exercises: [
                    { name: 'Barbell Flat Bench Press', setsReps: '4 Sets x 6-8 Reps' },
                    { name: 'Incline Dumbbell Press (Mid Chest)', setsReps: '3 Sets x 8-10 Reps' },
                    { name: 'Seated Dumbbell Press (Shoulders)', setsReps: '3 Sets x 8-10 Reps' },
                    { name: 'Cable Lateral Raise', setsReps: '3 Sets x 12-15 Reps' },
                    { name: 'Close Grip Bench Press', setsReps: '3 Sets x 8-10 Reps' },
                ]
            },
            'SUN-PULL-A': {
                title: 'PULL A (Sunday): Back Width Focus',
                focus: 'Emphasis on lats for V-taper development and high-volume bicep work.',
                color: 'bg-blue-50 text-blue-700 border-blue-300',
                exercises: [
                    { name: 'Weighted Pull-ups (or Lat Pulldown)', setsReps: '4 Sets x 8-10 Reps' },
                    { name: 'Seated Cable Row (Wide Grip)', setsReps: '3 Sets x 10-12 Reps' },
                    { name: 'Straight Arm Pulldown', setsReps: '3 Sets x 15 Reps' },
                    { name: 'Barbell Shrugs (Traps)', setsReps: '3 Sets x 10 Reps' },
                    { name: 'Barbell Bicep Curl', setsReps: '3 Sets x 8-10 Reps' },
                    { name: 'Reverse Grip EZ Bar Curl', setsReps: '3 Sets x 10-12 Reps' },
                ]
            },
            'MON-LEGS-A': {
                title: 'LEGS A (Monday): Quad Focus',
                focus: 'High intensity for quad sweep development.',
                color: 'bg-green-50 text-green-700 border-green-300',
                exercises: [
                    { name: 'Barbell Squats', setsReps: '4 Sets x 6-8 Reps' },
                    { name: 'Leg Extension (High Reps)', setsReps: '3 Sets x 15-20 Reps' },
                    { name: 'Hack Squat (or Narrow Stance Leg Press)', setsReps: '3 Sets x 10-12 Reps' },
                    { name: 'Lying Leg Curl (Hamstrings)', setsReps: '3 Sets x 10-12 Reps' },
                    { name: 'Seated Calf Raises', setsReps: '4 Sets x 10-15 Reps' },
                ]
            },
            'TUE-PUSH-B': {
                title: 'PUSH B (Tuesday): Shoulder Width & Triceps',
                focus: 'Prioritizing deltoid width and triceps detail; lower chest volume.',
                color: 'bg-red-50 text-red-700 border-red-300',
                exercises: [
                    { name: 'Standing Military Press', setsReps: '4 Sets x 6-8 Reps' },
                    { name: 'Dumbbell Lateral Raise (Heavy)', setsReps: '4 Sets x 12-15 Reps' },
                    { name: 'Reverse Pec Deck Fly (Rear Delts)', setsReps: '3 Sets x 15 Reps' },
                    { name: 'Incline Dumbbell Press (Upper Chest)', setsReps: '3 Sets x 8-10 Reps' },
                    { name: 'Triceps Rope Pushdown', setsReps: '4 Sets x 10-12 Reps' },
                    { name: 'Overhead Dumbbell Extension', setsReps: '3 Sets x 8-10 Reps' },
                ]
            },
            'WED-PULL-B': {
                title: 'PULL B (Wednesday): Back Thickness & Biceps Peak',
                focus: 'Heavy compound movements for back density and arm peak development.',
                color: 'bg-blue-50 text-blue-700 border-blue-300',
                exercises: [
                    { name: 'Deadlifts (or Heavy Rack Pulls)', setsReps: '4 Sets x 5 Reps' },
                    { name: 'Bent-Over Barbell Row', setsReps: '4 Sets x 8-10 Reps' },
                    { name: 'Lat Pulldown (Neutral Grip)', setsReps: '3 Sets x 10-12 Reps' },
                    { name: 'Cable Face Pulls (Rear Delts/Traps)', setsReps: '3 Sets x 15 Reps' },
                    { name: 'Dumbbell Preacher Curl', setsReps: '3 Sets x 8-10 Reps' },
                    { name: 'Hammer Curls', setsReps: '3 Sets x 10-12 Reps' },
                ]
            },
            'THU-LEGS-B': {
                title: 'LEGS B (Thursday): Hamstring & Glute Focus',
                focus: 'Targeting the posterior chain for balance and density.',
                color: 'bg-green-50 text-green-700 border-green-300',
                exercises: [
                    { name: 'Romanian Deadlifts (Hamstring Focus)', setsReps: '4 Sets x 8-10 Reps' },
                    { name: 'Seated Leg Curls (Isolation)', setsReps: '4 Sets x 12-15 Reps' },
                    { name: 'Leg Press (High/Narrow Stance)', setsReps: '3 Sets x 15-20 Reps' },
                    { name: 'Walking Lunges (Glutes/Quads Finisher)', setsReps: '3 Sets x 10 Reps/Leg' },
                    { name: 'Standing Calf Raises', setsReps: '4 Sets x 15-20 Reps' },
                ]
            },
            'FRI-REST': {
                title: 'ACTIVE REST (Friday)',
                focus: 'Full recovery is paramount for muscle retention during a cut.',
                color: 'bg-yellow-50 text-yellow-700 border-yellow-300',
                exercises: [
                    { name: 'Low Intensity Cardio (e.g., walk)', setsReps: '30-45 mins' },
                    { name: 'Deep Stretching / Foam Rolling', setsReps: '15 mins' },
                    { name: 'Sleep & Hydration Focus', setsReps: '8+ hours' },
                ]
            }
        };


        // --- Core AI Helper Functions (TTS and Chat) ---
        const apiKey = ""; 
        const FLASH_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const TTS_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;

        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate = 16000) {
            const numChannels = 1;
            const numSamples = pcm16.length;
            const buffer = new ArrayBuffer(44 + numSamples * 2);
            const view = new DataView(buffer);

            let pos = 0;

            view.setUint32(pos, 0x52494646, false); pos += 4;
            view.setUint32(pos, 36 + numSamples * 2, true); pos += 4;
            view.setUint32(pos, 0x57415645, false); pos += 4;
            view.setUint32(pos, 0x666d7420, false); pos += 4;
            view.setUint32(pos, 16, true); pos += 4;
            view.setUint16(pos, 1, true); pos += 2;
            view.setUint16(pos, numChannels, true); pos += 2;
            view.setUint32(pos, sampleRate, true); pos += 4;
            view.setUint32(pos, sampleRate * numChannels * 2, true); pos += 4;
            view.setUint16(pos, numChannels * 2, true); pos += 2;
            view.setUint16(pos, 16, true); pos += 2;
            view.setUint32(pos, 0x64617461, false); pos += 4;
            view.setUint32(pos, numSamples * 2, true); pos += 4;

            for (let i = 0; i < numSamples; i++) {
                view.setInt16(pos, pcm16[i], true);
                pos += 2;
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }

        async function callGeminiApi(url, payload, maxRetries = 5) {
            let lastError = null;
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.text();
                        throw new Error(`API call failed with status ${response.status}: ${errorBody}`);
                    }

                    return await response.json();

                } catch (error) {
                    lastError = error;
                    if (i < maxRetries - 1) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        console.error("Gemini API call failed after multiple retries.", lastError);
                        throw new Error("Failed to connect to the AI service. Please try again.");
                    }
                }
            }
        }
        
        // --- Chart Rendering Functions (Unchanged) ---

        function processLabel(label) {
            if (label.length <= 16) return label;
            const words = label.split(' ');
            let lines = [];
            let currentLine = '';
            words.forEach(word => {
                if ((currentLine + ' ' + word).length > 16 && currentLine.length > 0) {
                    lines.push(currentLine);
                    currentLine = word;
                } else {
                    currentLine = currentLine ? currentLine + ' ' + word : word;
                }
            });
            if (currentLine) lines.push(currentLine);
            return lines;
        }

        const sharedTooltipConfig = {
            plugins: {
                tooltip: {
                    callbacks: {
                        title: function(tooltipItems) {
                            const item = tooltipItems[0];
                            let label = item.chart.data.labels[item.dataIndex];
                            if (Array.isArray(label)) {
                              return label.join(' ');
                            } else {
                              return label;
                            }
                        }
                    }
                }
            },
            responsive: true,
            maintainAspectRatio: false
        };

        function renderMacroDonutChart() {
            const ctx = document.getElementById('macroDonutChart').getContext('2d');
            new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: chartData.macroLabels.map(processLabel),
                    datasets: [{
                        data: chartData.macroPercentages,
                        backgroundColor: chartData.chartColors.slice(0, 3),
                        hoverOffset: 15,
                    }]
                },
                options: {
                    ...sharedTooltipConfig,
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom' },
                        ...sharedTooltipConfig.plugins
                    }
                }
            });
        }

        function renderCalorieLineChart() {
            const ctx = document.getElementById('calorieLineChart').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartData.mealLabels.map(processLabel),
                    datasets: [{
                        label: `Calories Per Meal (Target: ${chartData.totalCalories} Total)`,
                        data: chartData.mealCalories,
                        borderColor: '#00C853',
                        backgroundColor: 'rgba(0, 200, 83, 0.2)',
                        tension: 0.4,
                        fill: true,
                        pointRadius: 6,
                        pointBackgroundColor: '#2196F3'
                    }]
                },
                options: {
                    ...sharedTooltipConfig,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Calories (kcal)', color: '#1E1E1E' } },
                        x: { title: { display: true, text: 'Meal Timing', color: '#1E1E1E' } }
                    },
                    plugins: {
                        legend: { display: false },
                        ...sharedTooltipConfig.plugins
                    }
                }
            });
        }

        function renderProteinBarChart() {
            const ctx = document.getElementById('proteinBarChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartData.proteinSources.map(d => d.source).map(processLabel),
                    datasets: [{
                        label: 'Protein (Grams)',
                        data: chartData.proteinSources.map(d => d.grams),
                        backgroundColor: chartData.proteinSources.map(d => d.color),
                    }]
                },
                options: {
                    ...sharedTooltipConfig,
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, title: { display: true, text: 'Grams of Protein', color: '#1E1E1E' } }
                    },
                    plugins: {
                        legend: { display: false },
                        ...sharedTooltipConfig.plugins
                    }
                }
            });
        }

        // --- KPI Update Function (Injection of values into HTML) ---
        function updateKPIs() {
            document.getElementById('kpi-calories').textContent = chartData.totalCalories;
            document.getElementById('kpi-protein').textContent = chartData.targetProtein;
            document.getElementById('kpi-carbs').textContent = chartData.targetCarbs;
            document.getElementById('kpi-fat').textContent = chartData.targetFat;

            document.getElementById('kpi-protein-perc').textContent = chartData.macroPercentages[0];
            document.getElementById('kpi-carbs-perc').textContent = chartData.macroPercentages[1];
            document.getElementById('kpi-fat-perc').textContent = chartData.macroPercentages[2];
            
            // Update labels with macro percentages
            document.getElementById('macro-p-perc').textContent = chartData.macroPercentages[0];
            document.getElementById('macro-c-perc').textContent = chartData.macroPercentages[1];
            document.getElementById('macro-f-perc').textContent = chartData.macroPercentages[2];
            
            // Update line chart subtitle
            document.getElementById('line-chart-total').textContent = chartData.totalCalories;
            
        }

        // --- Interactive Training Split Logic (New) ---
        function showWorkout(dayKey) {
            // 1. Update the button styles
            const dayTabs = document.querySelectorAll('.day-tab');
            dayTabs.forEach(tab => tab.classList.remove('active'));
            document.getElementById(dayKey).classList.add('active');

            // 2. Get the workout data
            const data = workoutData[dayKey];
            const contentDiv = document.getElementById('workoutDetailsContent');
            
            // 3. Generate the HTML for the selected workout
            let exercisesHtml = '';
            if (data.exercises.length > 0) {
                exercisesHtml = '<ul class="workout-list space-y-2">';
                data.exercises.forEach(ex => {
                    exercisesHtml += `
                        <li class="flex justify-between items-center">
                            <span class="exercise-name">${ex.name}</span>
                            <span class="sets-reps">${ex.setsReps}</span>
                        </li>
                    `;
                });
                exercisesHtml += '</ul>';
            } else {
                exercisesHtml = '<p class="text-gray-500 italic mt-4">No specific heavy lifting on this day. Focus on recovery and nutrition.</p>';
            }


            // 4. Update the content area
            contentDiv.innerHTML = `
                <div class="p-6 bg-white rounded-lg border-2 border-[#2196F3]">
                    <h3 class="text-2xl font-black text-[#2196F3] mb-2">${data.title}</h3>
                    <p class="text-gray-600 mb-4 font-semibold">${data.focus}</p>
                    <div class="p-4 bg-blue-50/50 rounded-md">
                        ${exercisesHtml}
                    </div>
                </div>
            `;
        }


        // --- AI Interaction Functions (Unchanged) ---
        async function generateSubstitution() {
            const inputFood = document.getElementById('inputFood').value.trim();
            const resultDiv = document.getElementById('substitutionResult');
            const button = document.getElementById('substitutionButton');

            if (!inputFood) {
                resultDiv.innerHTML = '<p class="text-red-500">Please enter a food item to substitute.</p>';
                return;
            }

            resultDiv.innerHTML = '<p class="text-gray-500 flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-accent-text" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating macro-matched swap...</p>';
            button.disabled = true;

            const systemPrompt = `You are an expert nutrition coach for competitive physique athletes. Your goal is to provide a single, clean, macro-matched food substitution based on the user's input. The current plan is a ${chartData.totalCalories} kcal cutting diet with ${chartData.targetProtein}g Protein, ${chartData.targetCarbs}g Carbs, ${chartData.targetFat}g Fat. Your substitution should maintain the high protein/low-fat focus. Provide only the food name, macronutrients, and a brief note on its use in the plan. Format the output as a simple paragraph.`;
            
            const userQuery = `I need a macro-matched substitute for "${inputFood}" in my cutting diet.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await callGeminiApi(FLASH_API_URL, payload);
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't find a suitable substitution.";
                
                resultDiv.innerHTML = `
                    <div class="mt-4 p-4 border border-[#2196F3] bg-blue-50 rounded-lg">
                        <h4 class="font-bold text-[#2196F3] mb-2">‚ú® Suggested Swap:</h4>
                        <p class="text-gray-800">${text}</p>
                    </div>
                `;
            } catch (error) {
                resultDiv.innerHTML = `<p class="text-red-500">Error generating substitution: ${error.message}</p>`;
            } finally {
                button.disabled = false;
            }
        }

        async function generateRationale() {
            const rationaleTopic = document.getElementById('rationaleTopic').value.trim();
            const rationaleResultDiv = document.getElementById('rationaleResult');
            const button = document.getElementById('rationaleButton');

            if (!rationaleTopic) {
                rationaleResultDiv.innerHTML = '<p class="text-red-500">Please enter a nutrition question (e.g., "Why high protein?").</p>';
                return;
            }

            rationaleResultDiv.innerHTML = '<p class="text-gray-500 flex items-center justify-center"><svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-accent-text" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Grounding response with current research...</p>';
            button.disabled = true;

            const systemPrompt = `You are a sports science researcher. Provide a concise, scientifically grounded, 3-4 sentence explanation for the user's nutrition question, focusing on bodybuilding and cutting phases, considering a ${chartData.totalCalories} kcal / ${chartData.targetProtein}g protein diet.`;
            
            const userQuery = `Explain the rationale behind this nutrition topic: "${rationaleTopic}"`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const result = await callGeminiApi(FLASH_API_URL, payload);
                const candidate = result.candidates?.[0];
                const text = candidate?.content?.parts?.[0]?.text || "Sorry, I couldn't retrieve a grounded scientific explanation.";
                
                let sourcesHtml = '';
                const groundingMetadata = candidate?.groundingMetadata;
                if (groundingMetadata && groundingMetadata.groundingAttributions) {
                    const sources = groundingMetadata.groundingAttributions
                        .map(attr => ({ uri: attr.web?.uri, title: attr.web?.title }))
                        .filter(source => source.uri && source.title)
                        .slice(0, 3);

                    if (sources.length > 0) {
                        sourcesHtml = '<div class="mt-3 text-xs text-gray-500">Sources: ' + 
                            sources.map(s => `<a href="${s.uri}" target="_blank" class="hover:underline">${s.title.substring(0, 30)}...</a>`).join(' | ') + 
                            '</div>';
                    }
                }

                rationaleResultDiv.innerHTML = `
                    <div class="mt-4 p-4 border border-[#00C853] bg-green-50 rounded-lg">
                        <h4 class="font-bold text-[#00C853] mb-2">üî¨ Scientific Rationale:</h4>
                        <p class="text-gray-800">${text}</p>
                        ${sourcesHtml}
                    </div>
                `;

            } catch (error) {
                rationaleResultDiv.innerHTML = `<p class="text-red-500">Error generating rationale: ${error.message}</p>`;
            } finally {
                button.disabled = false;
            }
        }
        
        async function speakPrinciples() {
            const principleText = document.getElementById('principles-text-container').innerText.replace(/\s+/g, ' ').trim();
            const audioPlayer = document.getElementById('audioPlayer');
            const button = document.getElementById('ttsButton');
            
            if (audioPlayer.paused === false && !audioPlayer.ended) {
                audioPlayer.pause();
                audioPlayer.currentTime = 0;
                button.innerHTML = 'üîä Hear Principles Read';
                button.classList.remove('bg-red-500', 'hover:bg-red-600');
                button.classList.add('bg-[#00C853]', 'hover:bg-[#8BC34A]');
                return;
            }

            button.disabled = true;
            button.innerHTML = '<svg class="animate-spin h-5 w-5 mr-3 inline text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Generating Audio...';
            
            const systemPrompt = `Read the following text in an informative and firm tone, suitable for a fitness professional.`;
            
            const payload = {
                contents: [{ parts: [{ text: principleText }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: "Kore" }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };
            
            try {
                const result = await callGeminiApi(TTS_API_URL, payload);
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const match = mimeType.match(/rate=(\d+)/);
                    const sampleRate = match ? parseInt(match[1], 10) : 16000;
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    
                    const audioUrl = URL.createObjectURL(wavBlob);
                    audioPlayer.src = audioUrl;
                    audioPlayer.play();
                    
                    button.innerHTML = 'üõë Stop Reading';
                    button.classList.remove('bg-[#00C853]', 'hover:bg-[#8BC34A]');
                    button.classList.add('bg-red-500', 'hover:bg-red-600');
                    
                    audioPlayer.onended = () => {
                        button.innerHTML = 'üîä Hear Principles Read';
                        button.classList.remove('bg-red-500', 'hover:bg-red-600');
                        button.classList.add('bg-[#00C853]', 'hover:bg-[#8BC34A]');
                    };
                } else {
                    console.error("TTS response missing audio data or invalid mime type:", mimeType);
                }
            } catch (error) {
                button.innerHTML = '‚ùå TTS Error';
                console.error("TTS Error:", error);
            } finally {
                button.disabled = false;
                if (button.innerHTML.includes('Generating') || button.innerHTML.includes('Error')) {
                     button.innerHTML = 'üîä Hear Principles Read';
                     button.classList.remove('bg-red-500', 'hover:bg-red-600');
                     button.classList.add('bg-[#00C853]', 'hover:bg-[#8BC34A]');
                }
            }
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            updateKPIs();
            renderMacroDonutChart();
            renderCalorieLineChart();
            renderProteinBarChart();
            
            // Initialize the interactive split by showing PUSH A
            showWorkout('SAT-PUSH-A');
        });

        // Expose functions globally for HTML calls
        window.generateSubstitution = generateSubstitution;
        window.generateRationale = generateRationale;
        window.speakPrinciples = speakPrinciples;
        window.showWorkout = showWorkout;

    </script>

    <div class="max-w-7xl mx-auto">

        <header class="text-center mb-12">
            <h1 class="text-5xl md:text-6xl font-extrabold accent-text leading-tight">The Aesthetic Cut Protocol</h1>
            <p class="text-xl md:text-2xl text-gray-600 mt-3">Classic Physique Nutrition & Training Blueprint for Definition</p>
        </header>

        
<!-- KPI Section -->
<section id="kpis" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-12">
            
            <div class="card p-6 text-center">
                <h2 class="text-sm uppercase font-bold text-gray-500 mb-2">Daily Calorie Target</h2>
                <div class="stat-number text-6xl font-black" id="kpi-calories"></div>
                <p class="text-gray-700 mt-2 font-semibold">kcal</p>
            </div>

            <div class="card p-6 text-center">
                <h2 class="text-sm uppercase font-bold text-gray-500 mb-2">Protein Intake (Minimum)</h2>
                <div class="stat-number text-6xl font-black" id="kpi-protein"></div>
                <p class="text-gray-700 mt-2 font-semibold">grams / <span id="kpi-protein-perc"></span>%</p>
            </div>

            <div class="card p-6 text-center">
                <h2 class="text-sm uppercase font-bold text-gray-500 mb-2">Carbohydrate Intake</h2>
                <div class="stat-number text-6xl font-black" id="kpi-carbs"></div>
                <p class="text-gray-700 mt-2 font-semibold">grams / <span id="kpi-carbs-perc"></span>%</p>
            </div>

            <div class="card p-6 text-center">
                <h2 class="text-sm uppercase font-bold text-gray-500 mb-2">Fat Intake (Essential)</h2>
                <div class="stat-number text-6xl font-black" id="kpi-fat"></div>
                <p class="text-gray-700 mt-2 font-semibold">grams / <span id="kpi-fat-perc"></span>%</p>
            </div>
            
        </section>

        
<!-- Macro Charts Section -->
        <section id="macro-composition" class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-12">
            
            <div class="lg:col-span-1 card border-t-4 border-t-[#00C853]">
                <h2 class="text-2xl font-bold accent-text mb-4">Macro Composition Overview</h2>
                <p class="text-gray-700 mb-6">This plan is a **highly aggressive, protein-centric cut**. The <span id="macro-p-perc"></span>% protein ensures maximum muscle retention while the lower carbs and moderate fats drive significant fat loss.</p>
                <div class="chart-container h-[350px]">
                    <canvas id="macroDonutChart"></canvas>
                </div>
                <p class="text-sm text-gray-500 mt-4 text-center">Breakdown: P (<span id="macro-p-perc"></span>%) C (<span id="macro-c-perc"></span>%) F (<span id="macro-f-perc"></span>%)</p>
            </div>

            <div class="lg:col-span-2 card border-t-4 border-t-[#2196F3]">
                <h2 class="text-2xl font-bold text-[#2196F3] mb-4">Calorie Distribution Across 5 Meals</h2>
                <p class="text-gray-700 mb-6">Calories are distributed to deliver large protein doses around critical times (morning, post-workout, bedtime), with solid meals supplementing energy from carbs and healthy fats. (Target: <span id="line-chart-total"></span> kcal Total)</p>
                <div class="chart-container h-[400px] max-w-full">
                    <canvas id="calorieLineChart"></canvas>
                </div>
            </div>
            
        </section>


<!-- Training Split & Details Section (INTERACTIVE) -->
        <section id="training-split" class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center border-b-2 pb-2 border-gray-200">üèãÔ∏è 7-Day High-Frequency Training Split (PPL-PPL)</h2>
            <p class="text-gray-700 text-center mb-8">Click any day below to see the specific exercises, sets, and rep ranges designed for classic physique aesthetics (V-taper, wide shoulders, round legs).</p>

            <!-- Interactive Day Tabs -->
            <div class="grid grid-cols-4 sm:grid-cols-7 gap-4 mb-8">
                
                <!-- SAT -->
                <button id="SAT-PUSH-A" onclick="showWorkout('SAT-PUSH-A')" class="day-tab p-4 text-center rounded-lg shadow-md bg-red-100 border border-red-400">
                    <div class="font-bold text-lg text-red-700">SAT</div>
                    <div class="text-sm font-black mt-1">PUSH A</div>
                </button>
                
                <!-- SUN -->
                <button id="SUN-PULL-A" onclick="showWorkout('SUN-PULL-A')" class="day-tab p-4 text-center rounded-lg shadow-md bg-blue-100 border border-blue-400">
                    <div class="font-bold text-lg text-blue-700">SUN</div>
                    <div class="text-sm font-black mt-1">PULL A</div>
                </button>
                
                <!-- MON -->
                <button id="MON-LEGS-A" onclick="showWorkout('MON-LEGS-A')" class="day-tab p-4 text-center rounded-lg shadow-md bg-green-100 border border-green-400">
                    <div class="font-bold text-lg text-green-700">MON</div>
                    <div class="text-sm font-black mt-1">LEGS A</div>
                </button>
                
                <!-- TUE -->
                <button id="TUE-PUSH-B" onclick="showWorkout('TUE-PUSH-B')" class="day-tab p-4 text-center rounded-lg shadow-md bg-red-100 border border-red-400">
                    <div class="font-bold text-lg text-red-700">TUE</div>
                    <div class="text-sm font-black mt-1">PUSH B</div>
                </button>
                
                <!-- WED -->
                <button id="WED-PULL-B" onclick="showWorkout('WED-PULL-B')" class="day-tab p-4 text-center rounded-lg shadow-md bg-blue-100 border border-blue-400">
                    <div class="font-bold text-lg text-blue-700">WED</div>
                    <div class="text-sm font-black mt-1">PULL B</div>
                </button>
                
                <!-- THU (NEW DETAIL) -->
                <button id="THU-LEGS-B" onclick="showWorkout('THU-LEGS-B')" class="day-tab p-4 text-center rounded-lg shadow-md bg-green-100 border border-green-400">
                    <div class="font-bold text-lg text-green-700">THU</div>
                    <div class="text-sm font-black mt-1">LEGS B</div>
                </button>
                
                <!-- FRI -->
                <button id="FRI-REST" onclick="showWorkout('FRI-REST')" class="day-tab p-4 text-center rounded-lg shadow-md bg-yellow-100 border border-yellow-400">
                    <div class="font-bold text-lg text-yellow-700">FRI</div>
                    <div class="text-sm font-black mt-1">REST</div>
                </button>
            </div>

            <!-- Workout Details Display Area -->
            <div id="workoutDetailsContent" class="min-h-[350px] transition-all duration-300">
                <!-- Content will be injected here by JavaScript -->
            </div>
            
        </section>


<!-- AI Tools Section (REMAINS) -->
<section id="ai-tools" class="mb-12">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 text-center border-b-2 pb-2 border-gray-200">ü§ñ AI Coach Assistant (Gemini-Powered)</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                
                <div class="card p-6 border-t-4 border-t-[#2196F3] bg-blue-50/50">
                    <h3 class="text-xl font-bold text-[#2196F3] mb-3 flex items-center">‚ú® Macro Substitution Generator</h3>
                    <p class="text-gray-700 text-sm mb-4">Need to swap out a food item while keeping your macros tight? The AI will suggest a macro-matched, cutting-friendly alternative.</p>
                    <input type="text" id="inputFood" placeholder="e.g., Brown Rice" class="w-full p-2 mb-3 border border-gray-300 rounded-md focus:ring-[#2196F3] focus:border-[#2196F3]">
                    <button id="substitutionButton" onclick="generateSubstitution()" class="w-full bg-[#2196F3] text-white py-2 rounded-md font-semibold hover:bg-blue-600 button-shadow">
                        Generate Swap
                    </button>
                    <div id="substitutionResult" class="mt-4 min-h-[50px]"></div>
                </div>

                <div class="card p-6 border-t-4 border-t-[#00C853] bg-green-50/50">
                    <h3 class="text-xl font-bold text-[#00C853] mb-3 flex items-center">üî¨ Scientific Rationale Finder</h3>
                    <p class="text-gray-700 text-sm mb-4">Get a quick, grounded scientific explanation for the principles in this plan. Utilizes real-time research.</p>
                    <input type="text" id="rationaleTopic" placeholder="e.g., Why high protein?" class="w-full p-2 mb-3 border border-gray-300 rounded-md focus:ring-[#00C853] focus:border-[#00C853]">
                    <button id="rationaleButton" onclick="generateRationale()" class="w-full bg-[#00C853] text-white py-2 rounded-md font-semibold hover:bg-green-600 button-shadow">
                        Search Rationale
                    </button>
                    <div id="rationaleResult" class="mt-4 min-h-[50px]"></div>
                </div>
            </div>
        </section>


<!-- Principles Section -->
        <section id="principles" class="mb-12">
            <h2 class="text-3xl font-bold accent-text mb-6 text-center">Non-Negotiable Principles of the Cut</h2>
            
            <audio id="audioPlayer" class="w-full mb-4" controls hidden></audio>
            
            <div id="principles-text-container" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <div class="card p-6 bg-gray-50 border-t-4 border-t-[#00C853]">
                    <div class="flex items-center mb-3">
                        <span class="text-2xl font-black text-[#00C853] mr-3">&#9733;</span>
                        <h3 class="text-xl font-semibold">Hyper-Hydration</h3>
                    </div>
                    <p class="text-gray-700 text-sm">Target 1.5 - 2 Gallons of water daily. With high protein intake, this is **critical** for kidney function, nutrient transport, and minimizing water retention for a "dry" look.</p>
                </div>

                <div class="card p-6 bg-gray-50 border-t-4 border-t-[#00C853]">
                    <div class="flex items-center mb-3">
                        <span class="text-2xl font-black text-[#00C853] mr-3">&#9733;</span>
                        <h3 class="text-xl font-semibold">Micro-Nutrient Density</h3>
                    </div>
                    <p class="text-gray-700 text-sm">Although protein is dominant, prioritize nutrient-dense whole foods like green, fibrous vegetables. These provide essential vitamins, minerals, and satiety with minimal calories.</p>
                </div>

                <div class="card p-6 bg-gray-50 border-t-4 border-t-[#00C853]">
                    <div class="flex items-center mb-3">
                        <span class="text-2xl font-black text-[#00C853] mr-3">&#9733;</span>
                        <h3 class="text-xl font-semibold">Precision & Adherence</h3>
                    </div>
                    <p class="text-gray-700 text-sm">With such tight macros, **accurate measurement** of whey and solid foods is paramount. Consistency in following this plan will be the key to achieving your physique goals.</p>
                </div>
            </div>
            <button id="ttsButton" onclick="speakPrinciples()" class="w-full mt-6 bg-[#00C853] text-white py-2 rounded-md font-semibold hover:bg-green-600 button-shadow flex items-center justify-center">
                üîä Hear Principles Read
            </button>
        </section>

    </div>
</body>
</html>
